# åŸåŠ›è®¡åˆ’-ä»é›¶å®ç°æœ€ç®€ http æœåŠ¡å™¨

> å‘¨æœ«äº†ï¼Œä½ å¸¦ä½ çš„ç ´ç”µè„‘å›åˆ°å®¶å¹¶ä¸èƒ½ç»™ä½ å¸¦æ¥ä»»ä½•å®è´¨æ€§ä½œç”¨ï¼Œæœ‹å‹ä»¬å…œé‡Œæå‡ºä¸€å¤§æŠŠé’±åƒå–ç©ä¹ï¼Œä½ é»˜é»˜çš„åœ¨å®¶é‡Œæ‘†å¼„ä½ çš„ç ´çƒ‚ javaï¼Œspring å…¨å®¶æ¡¶ï¼Œsrpingcloud çœ‹äº†å¤šå°‘éç®—æ³•ã€‚äº²æˆšæœ‹å‹åƒé¥­é—®ä½ æ”¶è·äº†ä»€ä¹ˆï¼Œä½ è¯´æˆ‘è£…äº†ä¸ªè™šæ‹Ÿæœºï¼ŒæŠŠå„ä¸ªå·¥å…·éƒ½ç©äº†ä¸€éï¼Œäº²æˆšä»¬æ‡µé€¼äº†ï¼Œä½ è¿˜åœ¨å¿ƒé‡Œé»˜é»˜å˜²ç¬‘ä»–ä»¬ï¼Œç¬‘ä»–ä»¬ä¸æ‡‚ä½ çš„è‡ªåŠ¨æ³¨å…¥ï¼Œä¸æ‡‚ä½ çš„ 10 å±‚ä»£ç†ã€ä¸æ‡‚ä½ çš„æµé‡æ··æ·†ï¼Œä¹Ÿç¬‘ä»–ä»¬è¿ä¸ªå¤æ‚ç‚¹çš„å¯†ç éƒ½è®°ä¸ä½ã€‚ä½ çˆ¶æ¯çš„åŒäº‹éƒ½åœ¨è¯´è‡ªå·±çš„å­å¥³ä¸€å¹´çš„æ”¶è·ï¼Œå„¿å­ä¹°äº†ä¸ªæˆ¿ï¼Œå¥³å„¿ä¹°äº†ä¸ªè½¦ï¼Œå§‘å¨˜å‡èŒåŠ è–ªäº†ï¼Œä½ çš„çˆ¶æ¯é»˜é»˜æ— è¨€ï¼Œè¯´æˆ‘çš„å„¿å­æäº†ä¸ªç ´ç”µè„‘ï¼Œå¼€èµ·æ¥å—¡å—¡å“ã€å®¶é‡Œç”µè¡¨èµ°å¾—è¶Šæ¥è¶Šå¿«äº†ã€‚

æˆ‘å°±æ˜¯é‚£ä¸ªæ®µå­é‡Œçš„<u>å¤§å†¤ç§</u>ï¼Œæ­£æ–‡å¼€å§‹å‰è‡ªæˆ‘è°ƒä¾ƒä¸€ä¸‹ã€‚

éšç€å·¥ä½œçš„å¹´é™çš„å¢é•¿ï¼Œè¶Šæ¥è¶Šéš¾å†™ä¸€äº›åŸºç¡€ä»£ç ï¼Œæ€»æ„Ÿè§‰è‡ªå·±çš„åº•å­æ‰“çš„æ¯”è¾ƒå·®ï¼Œå·¥ä½œä¸­å†™ä¸äº†ç¡¬æ ¸ä»£ç ï¼Œé‚£æˆ‘å°±ç”¨ä¸šä½™æ—¶é—´å®Œæˆå§ï¼æˆ‘ä¹ŸçŸ¥é“ç½‘ä¸Šä»£ç ä¸€å¤§å †ï¼ŒåŠæ—¶è‡ªå·±å®ç°äº†ä¹Ÿä¸è§å¾—æœ‰ä»€ä¹ˆæ”¶è·ï¼Œå°±å½“å­¦ä¹ ï¼Œç£¨ä¸€ç£¨ç”Ÿé”ˆçš„åˆ€ã€‚

è‹¥å¹²å¹´å‰åœ¨ä¸€ä¸ª java é¡¹ç›®ä¸­çœ‹åˆ°ç”¨çº¯ java æ‰‹æ’•å‰ç«¯ä»£ç ï¼Œå½“æ—¶è§‰çš„å¥½ç¥å¥‡ï¼Œä¹Ÿå¤§æ¦‚åªæœ‰åŠŸåŠ›æ·±åšï¼Œå¤§ç‰›æ‰èƒ½å†™å‡ºè¿™æ ·çš„ä»£ç ï¼Œæˆ‘ç­‰èœé¸¡åªèƒ½å†™å†™ CURD,ä¹Ÿè®¸æ˜¯é‚£ä¸ªæ—¶å€™åŸ‹ä¸‹çš„ç§å­å§ï¼Œtomcat æ²¡æœ‰ç²¾åŠ›å†™ï¼Œä½†å†™ä¸€ä¸ªç®€å•çš„ http æœåŠ¡å™¨ï¼Œè®©è‡ªå·±çš„ç½‘ç«™è·‘åœ¨è¿™ä¸ªæœåŠ¡å™¨ä¸Šï¼Œæƒ³æƒ³ä¹Ÿæ˜¯ç¾æ»‹æ»‹ï¼Œä»€ä¹ˆ tomcat,ä»€ä¹ˆ nginx,è‡ªå·±çš„æœåŠ¡å™¨è‡ªå·±æ¥å†™ã€‚

**HTTP æœåŠ¡å™¨ç›®æ ‡ï¼šè®©è‡ªå·±çš„ç½‘ç«™è·‘åœ¨æ‹¥æœ‰è‡ªä¸»çŸ¥è¯†äº§æƒçš„é™æ€æœåŠ¡å™¨ä¸Šã€‚**

å¼€å§‹å‰è¦ææ‡‚ http åè®®ã€‚

## HTTP åè®®

HTTP åè®®ä½¿ç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹ï¼Œå…¶ä¸­å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª HTTP è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨åˆ™è¿”å›ä¸€ä¸ª HTTP å“åº”ã€‚HTTP è¯·æ±‚ç”±è¯·æ±‚æ–¹æ³•ï¼ˆGETã€POSTã€PUTã€DELETE ç­‰ï¼‰å’Œè¯·æ±‚å¤´ï¼ˆåŒ…å«è¯·æ±‚ä¿¡æ¯çš„å…ƒæ•°æ®ï¼‰ç»„æˆï¼Œè€Œ HTTP å“åº”ç”±çŠ¶æ€ç ï¼ˆæè¿°æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å“åº”ï¼‰ã€å“åº”å¤´å’Œå“åº”æ­£æ–‡ï¼ˆåŒ…å«å®é™…æ•°æ®ï¼‰ç»„æˆã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ HTTP åè®®è¿›è¡Œè¯·æ±‚å’Œå“åº”çš„ç®€å• demoï¼š

1.  å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ GET è¯·æ±‚ï¼š

    ```
    GET /hello.txt HTTP/1.1
    Host: example.com
    User-Agent: Mozilla/5.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    ```

2.  æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€å“åº”ï¼š
    ```
    HTTP/1.1 200 OK
    Content-Type: text/plain
    Content-Length: 12

    Hello World!
    ```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒæœåŠ¡å™¨è¿”å›ä¸€ä¸ª HTTP/1.1 200 OK å“åº”ç ï¼Œè¡¨ç¤ºè¯·æ±‚æˆåŠŸã€‚å“åº”å¤´ä¸­åŒ…å«äº†ä¸€äº›é™„åŠ çš„ä¿¡æ¯ï¼Œä¾‹å¦‚è¿”å›çš„æ•°æ®ç±»å‹å’Œæ•°æ®é•¿åº¦ã€‚å“åº”æ­£æ–‡ä¸­åŒ…å«äº†å®é™…çš„æ•°æ®ï¼Œå³ Hello World!ã€‚

java ä»£ç å®ç°å¦‚ä¸‹ï¼š

```
public class SimpleHttp {
    private static int port;
    public static void main(String[] args) throws IOException {
        int port = 8080;
        ServerSocket ss = new ServerSocket(port);
        System.out.println("Simple http server started on port " + port);

        while (true) {
            Socket socket = ss.accept();
            System.out.println("New client connected");

            BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            String line;
            while ((line = in.readLine()) != null) {
                if (line.isEmpty()) {
                    break;
                }
                System.out.println(line);
            }
            String response = """
                    HTTP/1.1 200 OK

                    Hello, World!
                    """;
            OutputStream outputStream = socket.getOutputStream();
            outputStream.write(response.getBytes());
            outputStream.flush();
            outputStream.close();
        }
    }
}
```

ä»¥ä¸Šä»£ç åªæ˜¯å®ç°å¾ˆç®€å• demo,è¿˜è¿œè¿œä¸è¶³è·‘èµ·æ¥æˆ‘çš„ä¸ªäººç½‘ç«™ã€‚

## å®ç°é™æ€æœåŠ¡å™¨

åŸºäºä»¥ä¸Šçš„ä»£ç éª¨æ¶ï¼Œæˆ‘ä»¬æ¥ä¸°å¯Œä¸€ä¸‹ç»†èŠ‚ï¼š

```
public void start(int port) throws IOException {
        ServerSocket ss = new ServerSocket(port);
        System.out.println("Simple http server started on port " + port);
        HttpResponse response;
        while (true) {
            Socket socket = ss.accept();
            try {
                HttpRequest request = handleRequest(socket);
                response = handleResponse(request, socket);
            } catch (Exception e) {
                response = handle5xx();
            }
            response(response, socket);
        }
    }
```

å¯¹äº request å¤„ç†ï¼Œå…¶å®æ˜¯ä¸ºäº†è·å¾—è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„åŠ header ç­‰å…¶ä»–ä¿¡æ¯,

```
    private HttpRequest handleRequest(Socket socket) throws IOException {
        BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));
        String line;
        List<String> rawHeaders = new ArrayList<>(64);
        String firstLine = null;
        while ((line = in.readLine()) != null) {
            if (line.isEmpty()) {
                break;
            }
            if (firstLine == null) {
                firstLine = line;
            } else {
                rawHeaders.add(line);
            }
        }
        if (firstLine == null) {
            return null;
        }
        String[] array = firstLine.split(" ", 3);
        HttpRequest httpRequest = new HttpRequest(array[0], array[1], array[2]);
        httpRequest.setHeaders(rawHeaders);
        return httpRequest;
    }
```

æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°ä¸€ä¸‹ response

```
    private HttpResponse handleResponse(HttpRequest request, Socket socket) throws IOException {
        String path = request.getPath();
        HttpResponse response;
        try {
            if ("/".equalsIgnoreCase(path) || path.length() == 0) {
                path = "/index.html";
            } else if (path.indexOf(".") < 0) {
                path = path + ".html";
            }
            boolean flag = ResourcesFileUtil.isExistFile(path);
            if (!flag) {
                path = request.getPath() + "/index.html";
                flag = ResourcesFileUtil.isExistFile(path);
            }
            if (!flag) {
                response = handle404();
            } else {
                response = handleOk(path);
            }
        } catch (Exception e) {
            response = handle5xx();
        }
        return response;
    }
```

è¿™é‡Œæœ‰ä¸€äº›ç‰¹æ®Šé€»è¾‘å¤„ç†ï¼Œä¸»è¦æ˜¯å¤„ç†æ²¡æœ‰æ–‡ä»¶åç¼€å`.html`ï¼Œæˆ–è€…æ‰¾è¯¥è·¯å¾„ä¸‹çš„`index.html`

ç„¶åæ ¹æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå¦‚æœæ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œä½¿ç”¨`handle404`æ–¹æ³•æ¥å¤„ç†ï¼Œè¯¥æ–‡ä»¶å­˜åœ¨çš„è¯ï¼Œä½¿ç”¨`handleOk`æ¥å¤„ç†ã€‚

```
    private HttpResponse handle404() throws IOException {
        String body = "Page not fond!";
        HttpResponse response = new HttpResponse(404, body.getBytes());
        Headers headers = new Headers();
        headers.addHeader("Content-Type", ContextType.getContextType("html"));
        headers.addHeader("Content-Length", body.getBytes().length + "");
        headers.addHeader("Connection", "Close");
        response.setHeaders(headers);
        return response;
    }
```

```
    private HttpResponse handleOk(String path) throws IOException {
        String suffix = "html";
        if (path.lastIndexOf(".") > 0) {
            suffix = path.substring(path.lastIndexOf(".") + 1, path.length());
        }
        byte[] body = ResourcesFileUtil.getResource(path);
        HttpResponse response = new HttpResponse(200, body);
        Headers headers = new Headers();
        headers.addHeader("Content-Type", ContextType.getContextType(suffix));
        headers.addHeader("Content-Length", "" + body.length);
        response.setHeaders(headers);
        return response;
    }
```

æœ¬è´¨ä¸Šå°±æ˜¯å°è£…ç”Ÿæˆ http åè®®éœ€è¦çš„æ–‡æœ¬å†…å®¹ï¼Œå¯¹äºä¸åŒæ–‡ä»¶ç±»å‹ï¼Œè¦è¿”å›ä¸åŒçš„`Content-Type`ã€‚

```
public static String getContextType(String suffix) {
        assert suffix != null;
        switch (suffix.toLowerCase()) {
            case "html":
                return "text/html; charset=utf-8";
            case "css":
                return "text/css; charset=utf-8";
            case "js":
                return "text/javascript; charset=utf-8";
            case "jpeg":
            case "jpg":
                return "image/jpeg";
            case "png":
                return "image/png";
            case "gif":
                return "image/gif";
            case "ico":
                return "image/x-icon";
            case "json":
                return "application/json; charset=utf-8";
            default:
                return "text/plain; charset=utf-8";
        }
    }
```

ç”Ÿæˆå¥½å†…å®¹ä»¥åï¼Œå°†å†…å®¹è¿”å›åˆ°å®¢æˆ·ç«¯ï¼š

```
 private void response(HttpResponse response, Socket socket) throws IOException {
        OutputStream outputStream = socket.getOutputStream();
        outputStream.write(response.getFirstLine());
        outputStream.write(response.getHeaders().toString().getBytes());
        outputStream.write("\r\n".getBytes());
        outputStream.write(response.getBody());
        outputStream.flush();
        outputStream.close();
    }
```

å…³äºå…¶ä»–ä»£ç å°±çœç•¥äº†ï¼Œä¸»è¦æ˜¯å°è£…å’Œå¤ç”¨å§ï¼Œå…·ä½“ä»£ç çœ‹æºç å§ã€‚

è®¿é—® http://localhost:8080/ è¿™ä¸‹å°±èƒ½çœ‹åˆ°æˆ‘çš„ç½‘ç«™å•¦ï¼çº¯çº¯çš„é«˜ç§‘æŠ€ï¼Œè‡ªä¸»å¯æ§ï¼

```
Simple http server started on port 8080
2023-03-26 22:42:32 INFO GET /  Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36
```

![Img](http://static.trumandu.top/yank-note-picgo-img-20230326224311.png)

## NIO å®ç°é™æ€æœåŠ¡å™¨

ä»¥ä¸Šå®ç°å·²ç»å¯ä»¥å®Œç¾çš„è¿è¡Œæˆ‘çš„ç½‘ç«™äº†ï¼Œç¾ä¸­ä¸è¶³çš„æ˜¯æœåŠ¡å™¨ç«¯æ˜¯é˜»å¡æœåŠ¡ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œæˆ‘ä»¬å†åŸºäº Java NIO æ¥ä¸ªæ€§èƒ½ç‰ˆï¼Œä½¿ç”¨ Selector å’Œ ServerSocketChannel å®ç°å¤šè·¯å¤ç”¨é™æ€æœåŠ¡å™¨ã€‚

ä¿®æ”¹äº‹ä»¶å¤„ç†é€»è¾‘ï¼š

```
    public void start(int port) throws IOException {
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.bind(new InetSocketAddress(port));
        ssc.configureBlocking(false);
        System.out.println("Simple http server started on port " + port);

        Selector selector = Selector.open();
        ssc.register(selector, SelectionKey.OP_ACCEPT);
        while (true) {
            int readNum = selector.select();
            if (readNum == 0) {
                continue;
            }
            Set<SelectionKey> selectionKeys = selector.selectedKeys();
            Iterator<SelectionKey> iterator = selectionKeys.iterator();
            while (iterator.hasNext()) {
                SelectionKey selectionKey = iterator.next();
                iterator.remove();
                //å¤„ç†è¿æ¥å°±ç»ªäº‹ä»¶
                if (selectionKey.isAcceptable()) {
                    ServerSocketChannel channel = (ServerSocketChannel) selectionKey.channel();
                    SocketChannel socketChannel = channel.accept();
                    socketChannel.configureBlocking(false);
                    socketChannel.register(selector, SelectionKey.OP_READ);
                } else if (selectionKey.isReadable()) {
                    handleRequest(selectionKey);
                    // æ³¨å†Œä¸€ä¸ªå†™äº‹ä»¶ï¼Œç”¨æ¥ç»™å®¢æˆ·ç«¯è¿”å›ä¿¡æ¯
                    selectionKey.interestOps(SelectionKey.OP_WRITE);
                } else if (selectionKey.isWritable()) {
                    handleResponse(selectionKey);
                }
            }
        }
    }
```

å¤„ç†è¯»è¯·æ±‚ï¼š

```
    private void handleRequest(SelectionKey selectionKey) throws IOException {
        SocketChannel socketChannel = (SocketChannel) selectionKey.channel();
        ByteBuffer buffer = ByteBuffer.allocate(1024);
        socketChannel.read(buffer);
        byte[] requestBytes = buffer.array();
        int readBytes;
        while ((readBytes = socketChannel.read(buffer)) != 0) {
            if (readBytes == -1) {
                // å¦‚æœè¯»åˆ°äº†æµçš„æœ«å°¾ï¼Œåˆ™è¡¨ç¤ºè¿æ¥å·²ç»æ–­å¼€
                break;
            }
            buffer.flip();
            int size = buffer.array().length;
            byte[] temp = new byte[requestBytes.length + size];
            System.arraycopy(requestBytes, 0, temp, 0, requestBytes.length);
            System.arraycopy(buffer.array(), 0, temp, requestBytes.length, size);
            requestBytes = temp;
            buffer.clear();
        }
        String context = new String(requestBytes);

        String[] lines = context.split("\r\n");
        String firstLine = null;
        List<String> rawHeaders = new ArrayList<>(64);
        for (int i = 0; i < lines.length; i++) {
            String line = lines[i];
            if (i == 0) {
                firstLine = line;
            } else {
                rawHeaders.add(line);
            }
        }
        if (firstLine == null) {
            return;
        }

        String[] array = firstLine.split(" ", 3);
        HttpRequest httpRequest = new HttpRequest(array[0], array[1], array[2]);
        httpRequest.setHeaders(rawHeaders);
        selectionKey.attach(httpRequest);
    }
```

å¤„ç†å†™è¯·æ±‚ï¼š

```
    private void handleResponse(SelectionKey selectionKey) throws IOException {
        SocketChannel channel = (SocketChannel) selectionKey.channel();
        HttpRequest request = (HttpRequest) selectionKey.attachment();
        String path = request.getPath();
        HttpResponse response;
        try {
            if ("/".equalsIgnoreCase(path) || path.length() == 0) {
                path = "/index.html";
            } else if (path.indexOf(".") < 0) {
                path = path + ".html";
            }
            boolean flag = ResourcesFileUtil.isExistFile(path);
            if (!flag) {
                path = request.getPath() + "/index.html";
                flag = ResourcesFileUtil.isExistFile(path);
            }
            if (!flag) {
                response = handle404();
            } else {
                response = handleOk(path);
            }
        } catch (Exception e) {
            response = handle5xx();
        }
        channel.write(ByteBuffer.wrap(response.getFirstLine()));
        channel.write(ByteBuffer.wrap(response.getHeaders().toString().getBytes()));
        channel.write(ByteBuffer.wrap("\r\n".getBytes()));
        channel.write(ByteBuffer.wrap(response.getBody()));
        channel.close();
    }
```

æœ¬æ–‡æ‰€æœ‰ä»£ç ï¼š[https://github.com/TrumanDu/the-force](https://github.com/TrumanDu/the-force/tree/main/simple-httpd)

## è¯´æ˜

ğŸ™Œ å¦‚æœä½ é˜…è¯»åˆ°è¿™é‡Œï¼Œç›¸ä¿¡æˆ‘ä»¬ä¸€å®šæ˜¯**åŒé“ä¸­äºº**ï¼Œæœ‰ä»»ä½•æƒ³æ³•ï¼Œæ¬¢è¿**ç§èŠ**æˆ‘ï¼Œå¾®ä¿¡å·ï¼š**trumandu007**ã€‚
ğŸ’¡ å¦‚æœä½ ä¹Ÿæ˜¯åœ¨è¥¿å®‰åœ°åŒºä»äº‹ IT ç›¸å…³å·¥ä½œï¼Œæ¬¢è¿ç§ä¿¡åŠ å…¥æˆ‘å»ºçš„ **ã€è¥¿å®‰ IT æŠ€æœ¯åœˆã€**å¾®ä¿¡ç¾¤,æˆ‘ä»¬æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„ç¾¤ä½“ï¼Ÿ [ä¸ºä»€ä¹ˆè¦åšã€è¥¿å®‰ IT æŠ€æœ¯åœˆã€](https://mp.weixin.qq.com/s?__biz=MzI4NTMwNTQ5Mg==&mid=2247483684&idx=1&sn=4c1f96c16463601a7e220a06649f4cd3)ã€‚
ğŸ‘¬ğŸ» æœ‹å‹ï¼Œéƒ½çœ‹åˆ°è¿™äº†ï¼Œç¡®å®šä¸å…³æ³¨ä¸€ä¸‹ä¹ˆ ğŸ‘‡

![](http://static.trumandu.top/trumandu_wechat_2022.png)
