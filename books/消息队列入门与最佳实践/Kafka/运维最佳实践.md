# è¿ç»´æœ€ä½³å®è·µ

## Lagç›‘æ§

æ¨èä½¿ç”¨æˆ‘ä¸»å¯¼å¼€æºçš„é¡¹ç›®[KCenter](https://github.com/xaecbd/KCenter)

å¦‚æœå¸Œæœ›è‡ªç ”ä»£ç ç›‘æ§Lagçš„è¯ï¼Œæ¨èæŸ¥çœ‹æˆ‘å†™çš„æ–‡ç« ï¼š[å¦‚ä½•ç›‘æ§kafkaæ¶ˆè´¹Lagæƒ…å†µ](http://blog.trumandu.top/2019/04/13/%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7kafka%E6%B6%88%E8%B4%B9Lag%E6%83%85%E5%86%B5/)

## Rebalance Topic

Relalance Topicæ¨èé‡‡ç”¨å®˜æ–¹è„šæœ¬å·¥å…·`kafka-reassign-partitions`å’Œ`kafka-preferred-replica-election`

å·¥ä½œåŸç†æ˜¯æ›´æ”¹zkä¸Šçš„é…ç½®ï¼Œç„¶åè§¦å‘é€‰ä¸¾ç”Ÿæ•ˆã€‚

**ä¸€ã€æ ¹æ®Topic ç”Ÿæˆè¦è¿ç§»çš„partitionæ–¹æ¡ˆ**

```
./bin/kafka-reassign-partitions.sh --topics-to-move-json-file topics-to-move.json --broker-list "1,2,3,4,5,6,7" --generate --zookeeper localhost:2181
```
å…¶ä¸­567ä¸ºæ–°åŠ å…¥çš„broker

topics-to-move.json
```
{"topics":
     [{"topic": "foo1"},{"topic": "foo2"}],
     "version":1
}
```
**äºŒã€æ‰§è¡Œpartitionæ–¹æ¡ˆ**

```
$ ./bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file partitions-to-move.json --execute
```

partitions-to-move.json
```
{"partitions":
             [{"topic": "foo",
               "partition": 1,
               "replicas": [1,2,4] }],              
  "version":1
}
```

åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è®°å¾—ä¿ç•™åŸå§‹åˆ†é…æ–¹æ¡ˆ

éªŒè¯æ‰§è¡Œç»“æœï¼š
```
$ ./bin/kafka-reassign-partitions.sh --zookeeper localhost:2181  --reassignment-json-file partitions-to-move.json --verify
```


TipsğŸ’—: 
å¯¹äºæ•´ä¸ªé›†ç¾¤çš„æ“ä½œï¼Œæ¨èåŠ å…¥é™æµå‚æ•°`--throttle`ï¼Œé¿å…æµé‡è¿‡é«˜å½±å“æ•´ä¸ªé›†ç¾¤æ€§èƒ½ã€‚å•ä½ä¸ºbytes/secï¼Œæœ€å°ä¸º1000(1 KB/s)ã€‚

ä¾‹å¦‚ï¼š é™åˆ¶æµé‡ä¸º100MB/s
```
$ ./bin/kafka-reassign-partitions.sh --throttle 100000000 --zookeeper localhost:2181 --reassignment-json-file partitions-to-move.json --execute

```

**ä¸‰ã€ä¼˜å…ˆå‰¯æœ¬é‡æ–°é€‰ä¸¾**
```
bin/kafka-preferred-replica-election.sh --zookeeper localhost:12913/kafka --path-to-json-file topicPartitionList.json
```

topicPartitionList.json
```
{
 "partitions":
  [
    {"topic": "topic1", "partition": 0},
    {"topic": "topic1", "partition": 1},
    {"topic": "topic1", "partition": 2},
    {"topic": "topic2", "partition": 0},
    {"topic": "topic2", "partition": 1}
  ]
}
```

## é‡æ–°é€‰ä¸¾Kafka controller

åœ¨zookeeperä¸Šåˆ é™¤`/controller`

## ä¸‹çº¿Kafka Leader

è¯¥æ“ä½œå¯ä»¥å‚è€ƒrelalanceæ–¹å¼ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œä¸æ›´æ”¹topicä¸Špartitionåˆ†é…æ–¹æ¡ˆï¼Œåªæ˜¯è°ƒæ•´ä¸€ä¸‹é¡ºåºã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šä¸æ˜¯ä¸‹çº¿ï¼Œåªæ˜¯è°ƒæ•´äº†leaderã€‚

**ä¸€ã€æ‰§è¡Œpartitionæ–¹æ¡ˆ**

ä¾‹å¦‚æˆ‘ä»¬éœ€è¦å°†topic:foo partiton 1 çš„åŸleader 2ä¸‹çº¿

åŸæ–¹æ¡ˆï¼š

```
{"partitions":
             [{"topic": "foo",
               "partition": 1,
               "replicas": [2,1,4] }],              
  "version":1
}
```

åªéœ€è¦è°ƒæ•´replicasæ•°ç»„çš„é¡ºåºå°±å¥½ã€‚

```
$ ./bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file partitions-to-move.json --execute
```

partitions-to-move.json
```
{"partitions":
             [{"topic": "foo",
               "partition": 1,
               "replicas": [1,4,2] }],              
  "version":1
}
```



éªŒè¯æ‰§è¡Œç»“æœï¼š
```
$ ./bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file partitions-to-move.json --verify
```

TipsğŸ’—: 
å¯¹äºæ•´ä¸ªé›†ç¾¤çš„æ“ä½œï¼Œæ¨èåŠ å…¥é™æµå‚æ•°`--throttle`ï¼Œé¿å…æµé‡è¿‡é«˜å½±å“æ•´ä¸ªé›†ç¾¤æ€§èƒ½ã€‚å•ä½ä¸ºbytes/secï¼Œæœ€å°ä¸º1000(1 KB/s)ã€‚

ä¾‹å¦‚ï¼š é™åˆ¶æµé‡ä¸º100MB/s
```
$ ./bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --throttle 100000000 --reassignment-json-file partitions-to-move.json --execute

```

**äºŒã€ä¼˜å…ˆå‰¯æœ¬é‡æ–°é€‰ä¸¾**

```
bin/kafka-preferred-replica-election.sh --zookeeper localhost:12913/kafka --path-to-json-file topicPartitionList.json
```

topicPartitionList.json
```
{
 "partitions":
  [
    {"topic": "foo", "partition": 1},
  ]
}
```

## æœºå™¨æ›´æ¢

- ä½¿ç”¨è„šæœ¬(bin/kafka-server-stop.sh)åœæ­¢broker
- æ‹·è´è¯¥æœºå™¨æ•°æ®ç›®å½•åˆ°æ–°æœºå™¨ä¸Š
- æ–°æœºå™¨ä½¿ç”¨åŸæœºå™¨çš„broker id,ç„¶åé‡æ–°å¯åŠ¨æœåŠ¡å³å¯ã€‚

## å¤§æµé‡åº”å¯¹ä¹‹é“

### é™æµ

### æ•°æ®åˆ é™¤

### æ‰©å®¹

## å…³é”®æŒ‡æ ‡ç›‘æ§

- BytesIn/BytesOutï¼šå³Brokerç«¯æ¯ç§’â¼Šç«™å’Œå‡ºç«™å­—èŠ‚æ•°ã€‚ä½ è¦ç¡®ä¿è¿™ç»„å€¼ä¸è¦æ¥è¿‘ä½ çš„â½¹ç»œå¸¦å®½ï¼Œå¦åˆ™è¿™é€šå¸¸éƒ½è¡¨ç¤ºâ½¹å¡å·² è¢«â€œæ‰“æ»¡â€ï¼Œå¾ˆå®¹æ˜“å‡ºç°â½¹ç»œä¸¢åŒ…çš„æƒ…å½¢ã€‚
- MessagesIn:å³Brokerç«¯æ¯ç§’â¼Šç«™æ¶ˆæ¯æ¡æ•°
- NetworkProcessorAvgIdlePercentï¼šå³â½¹ç»œçº¿ç¨‹æ± çº¿ç¨‹å¹³å‡çš„ç©ºé—²â½ä¾‹ã€‚é€šå¸¸æ¥è¯´ï¼Œä½ åº”è¯¥ç¡®ä¿è¿™ä¸ªJMXå€¼â»“æœŸâ¼¤äº 30%ã€‚å¦‚æœâ¼©äºè¿™ä¸ªå€¼ï¼Œå°±è¡¨æ˜ä½ çš„â½¹ç»œçº¿ç¨‹æ± â¾®å¸¸ç¹å¿™ï¼Œä½ éœ€è¦é€šè¿‡å¢åŠ â½¹ç»œçº¿ç¨‹æ•°æˆ–å°†è´Ÿè½½è½¬ç§»ç»™å…¶ä»–æœåŠ¡å™¨çš„â½… å¼ï¼Œæ¥ç»™è¯¥Brokerå‡è´Ÿã€‚
- RequestHandlerAvgIdlePercentï¼šå³I/Oçº¿ç¨‹æ± çº¿ç¨‹å¹³å‡çš„ç©ºé—²â½ä¾‹ã€‚åŒæ ·åœ°ï¼Œå¦‚æœè¯¥å€¼â»“æœŸâ¼©äº30%ï¼Œä½ éœ€è¦è°ƒæ•´I/Oçº¿ç¨‹ æ± çš„æ•°é‡ï¼Œæˆ–è€…å‡å°‘Brokerç«¯çš„è´Ÿè½½ã€‚
- UnderReplicatedPartitionsï¼šå³æœªå……åˆ†å¤‡ä»½çš„åˆ†åŒºæ•°ã€‚æ‰€è°“æœªå……åˆ†å¤‡ä»½ï¼Œæ˜¯æŒ‡å¹¶â¾®æ‰€æœ‰çš„Followerå‰¯æœ¬éƒ½å’ŒLeaderå‰¯æœ¬ä¿æŒ åŒæ­¥ã€‚â¼€æ—¦å‡ºç°äº†è¿™ç§æƒ…å†µï¼Œé€šå¸¸éƒ½è¡¨æ˜è¯¥åˆ†åŒºæœ‰å¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸¢å¤±ã€‚å› æ­¤ï¼Œè¿™æ˜¯â¼€ä¸ªâ¾®å¸¸é‡è¦çš„JMXæŒ‡æ ‡ã€‚
- ISRShrink/ISRExpandï¼šå³ISRæ”¶ç¼©å’Œæ‰©å®¹çš„é¢‘æ¬¡æŒ‡æ ‡ã€‚å¦‚æœä½ çš„ç¯å¢ƒä¸­å‡ºç°ISRä¸­å‰¯æœ¬é¢‘ç¹è¿›å‡ºçš„æƒ…å½¢ï¼Œé‚£ä¹ˆè¿™ç»„å€¼â¼€å®š æ˜¯å¾ˆâ¾¼çš„ã€‚è¿™æ—¶ï¼Œä½ è¦è¯Šæ–­ä¸‹å‰¯æœ¬é¢‘ç¹è¿›å‡ºISRçš„åŸå› ï¼Œå¹¶é‡‡å–é€‚å½“çš„æªæ–½ã€‚
- ActiveControllerCountï¼šå³å½“å‰å¤„äºæ¿€æ´»çŠ¶æ€çš„æ§åˆ¶å™¨çš„æ•°é‡ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼ŒControlleræ‰€åœ¨Brokerä¸Šçš„è¿™ä¸ªJMXæŒ‡æ ‡å€¼åº” è¯¥æ˜¯1ï¼Œå…¶ä»–Brokerä¸Šçš„è¿™ä¸ªå€¼æ˜¯0ã€‚å¦‚æœä½ å‘ç°å­˜åœ¨å¤šå°Brokerä¸Šè¯¥å€¼éƒ½æ˜¯1çš„æƒ…å†µï¼Œâ¼€å®šè¦èµ¶å¿«å¤„ç†ï¼Œå¤„ç†â½…å¼ä¸»è¦æ˜¯æŸ¥ çœ‹â½¹ç»œè¿é€šæ€§ã€‚è¿™ç§æƒ…å†µé€šå¸¸è¡¨æ˜é›†ç¾¤å‡ºç°äº†è„‘è£‚ã€‚è„‘è£‚é—®é¢˜æ˜¯â¾®å¸¸ä¸¥é‡çš„åˆ†å¸ƒå¼æ•…éšœï¼ŒKafkaâ½¬å‰ä¾æ‰˜ZooKeeperæ¥é˜²â½Œ è„‘è£‚ã€‚ä½†â¼€æ—¦å‡ºç°è„‘è£‚ï¼ŒKafkaæ˜¯â½†æ³•ä¿è¯æ­£å¸¸â¼¯ä½œçš„ã€‚

## å‚è€ƒ
1. [PreferredReplicaLeaderElectionTool](https://cwiki.apache.org/confluence/display/KAFKA/Replication+tools#Replicationtools-1.PreferredReplicaLeaderElectionTool)
2. [replication](https://kafka.apache.org/documentation/#replication)